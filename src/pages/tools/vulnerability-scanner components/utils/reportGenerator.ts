export interface ScanResult {
  repo_url: string;
  language: string;
  scan_results?: Array<{
    cve_id: string;
    package: string;
    severity: string;
    description: string;
    references?: string[];
  }>;
  error?: {
    type: string;
    message: string;
    step: string;
  };
}

export class ReportGenerator {
  static generateCSVReport(scanResult: ScanResult): string {
    if (!scanResult.scan_results || scanResult.scan_results.length === 0) {
      return 'Repository URL,Language,Total Vulnerabilities,Status\n' +
             `"${scanResult.repo_url}","${scanResult.language}",0,"No vulnerabilities found"`;
    }
    
    const headers = ['CVE ID', 'Package', 'Severity', 'Description', 'References'];
    const csvRows = [headers.join(',')];
    
    scanResult.scan_results.forEach(vuln => {
      const row = [
        `"${vuln.cve_id || 'N/A'}"`,
        `"${vuln.package || 'N/A'}"`,
        `"${vuln.severity}"`,
        `"${(vuln.description || 'No description').replace(/"/g, '""')}"`,
        `"${(vuln.references || []).join('; ').replace(/"/g, '""')}"`
      ];
      csvRows.push(row.join(','));
    });
    
    return csvRows.join('\n');
  }
  
  static downloadCSVReport(scanResult: ScanResult, filename: string = 'vulnerability-report.csv'): void {
    const csvContent = this.generateCSVReport(scanResult);
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    
    if (link.download !== undefined) {
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', filename);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }
  }
}